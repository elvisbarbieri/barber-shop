{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "5373357346405448911"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]"
    },
    "projectName": {
      "type": "string",
      "defaultValue": "barberdist"
    },
    "environment": {
      "type": "string",
      "defaultValue": "dev"
    }
  },
  "variables": {
    "functionAppName": "[format('{0}-func-{1}', parameters('projectName'), parameters('environment'))]",
    "storageAccountPrefix": "[substring(replace(parameters('projectName'), '-', ''), 0, min(10, length(replace(parameters('projectName'), '-', ''))))]",
    "storageAccountSuffix": "[substring(uniqueString(resourceGroup().id), 0, 13)]",
    "storageAccountName": "[format('{0}{1}', variables('storageAccountPrefix'), variables('storageAccountSuffix'))]",
    "appServicePlanName": "[format('{0}-plan-{1}', parameters('projectName'), parameters('environment'))]",
    "apimServiceName": "[format('{0}-apim-{1}', parameters('projectName'), parameters('environment'))]",
    "apimBaseUrl": "[parameters('projectName')]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "storageAccount",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[variables('storageAccountName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "8483810492468473041"
            }
          },
          "parameters": {
            "name": {
              "type": "string"
            },
            "location": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2023-01-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "kind": "StorageV2",
              "sku": {
                "name": "Standard_LRS"
              },
              "properties": {
                "supportsHttpsTrafficOnly": true,
                "minimumTlsVersion": "TLS1_2",
                "allowBlobPublicAccess": false
              }
            }
          ],
          "outputs": {
            "storageAccountName": {
              "type": "string",
              "value": "[parameters('name')]"
            },
            "storageAccountId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Storage/storageAccounts', parameters('name'))]"
            },
            "storageAccountPrimaryEndpoints": {
              "type": "object",
              "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', parameters('name')), '2023-01-01').primaryEndpoints]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "appServicePlan",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[variables('appServicePlanName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "15101928915547579221"
            }
          },
          "parameters": {
            "name": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "sku": {
              "type": "string",
              "defaultValue": "Y1"
            },
            "tier": {
              "type": "string",
              "defaultValue": "Dynamic"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2023-01-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "kind": "functionapp",
              "sku": {
                "name": "[parameters('sku')]",
                "tier": "[parameters('tier')]"
              },
              "properties": {
                "reserved": true
              }
            }
          ],
          "outputs": {
            "appServicePlanId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Web/serverfarms', parameters('name'))]"
            },
            "appServicePlanName": {
              "type": "string",
              "value": "[parameters('name')]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "functionApp",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[variables('functionAppName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "storageAccountName": {
            "value": "[variables('storageAccountName')]"
          },
          "appServicePlanId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'appServicePlan'), '2025-04-01').outputs.appServicePlanId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "18136175876599458682"
            }
          },
          "parameters": {
            "name": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "storageAccountName": {
              "type": "string"
            },
            "appServicePlanId": {
              "type": "string"
            }
          },
          "variables": {
            "functionAppVersion": "~4",
            "nodeVersion": "18"
          },
          "resources": [
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2023-01-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "kind": "functionapp,linux",
              "properties": {
                "serverFarmId": "[parameters('appServicePlanId')]",
                "reserved": true,
                "httpsOnly": true,
                "clientAffinityEnabled": false,
                "siteConfig": {
                  "linuxFxVersion": "[format('NODE|{0}', variables('nodeVersion'))]",
                  "appSettings": [
                    {
                      "name": "AzureWebJobsStorage",
                      "value": "[format('DefaultEndpointsProtocol=https;AccountName={0};EndpointSuffix={1};AccountKey={2}', parameters('storageAccountName'), environment().suffixes.storage, listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2023-01-01').keys[0].value)]"
                    },
                    {
                      "name": "WEBSITE_CONTENTAZUREFILECONNECTIONSTRING",
                      "value": "[format('DefaultEndpointsProtocol=https;AccountName={0};EndpointSuffix={1};AccountKey={2}', parameters('storageAccountName'), environment().suffixes.storage, listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2023-01-01').keys[0].value)]"
                    },
                    {
                      "name": "WEBSITE_CONTENTSHARE",
                      "value": "[toLower(parameters('name'))]"
                    },
                    {
                      "name": "FUNCTIONS_EXTENSION_VERSION",
                      "value": "[variables('functionAppVersion')]"
                    },
                    {
                      "name": "FUNCTIONS_WORKER_RUNTIME",
                      "value": "node"
                    },
                    {
                      "name": "WEBSITE_NODE_DEFAULT_VERSION",
                      "value": "[format('~{0}', variables('nodeVersion'))]"
                    },
                    {
                      "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
                      "value": ""
                    }
                  ]
                }
              }
            }
          ],
          "outputs": {
            "functionAppName": {
              "type": "string",
              "value": "[parameters('name')]"
            },
            "functionAppResourceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Web/sites', parameters('name'))]"
            },
            "functionAppHostName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/sites', parameters('name')), '2023-01-01').defaultHostName]"
            },
            "functionAppUrl": {
              "type": "string",
              "value": "[format('https://{0}', reference(resourceId('Microsoft.Web/sites', parameters('name')), '2023-01-01').defaultHostName)]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'appServicePlan')]",
        "[resourceId('Microsoft.Resources/deployments', 'storageAccount')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "apiManagement",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[variables('apimServiceName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "baseUrl": {
            "value": "[variables('apimBaseUrl')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "9889256041527334760"
            }
          },
          "parameters": {
            "name": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "baseUrl": {
              "type": "string"
            },
            "publisherName": {
              "type": "string",
              "defaultValue": "Distrito Barbearia"
            },
            "publisherEmail": {
              "type": "string",
              "defaultValue": "admin@distritobarbearia.com"
            },
            "sku": {
              "type": "string",
              "defaultValue": "Consumption"
            },
            "skuCount": {
              "type": "int",
              "defaultValue": 0
            }
          },
          "resources": [
            {
              "type": "Microsoft.ApiManagement/service",
              "apiVersion": "2023-05-01-preview",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "[parameters('sku')]",
                "capacity": "[parameters('skuCount')]"
              },
              "properties": {
                "publisherName": "[parameters('publisherName')]",
                "publisherEmail": "[parameters('publisherEmail')]",
                "notificationSenderEmail": "[parameters('publisherEmail')]",
                "customProperties": {
                  "Microsoft.WindowsAzure.ApiManagement.Gateway.Protocols.Server.Http2": "false",
                  "Microsoft.WindowsAzure.ApiManagement.Gateway.Security.Backend.Protocols.Ssl30": "false",
                  "Microsoft.WindowsAzure.ApiManagement.Gateway.Security.Backend.Protocols.Tls10": "false",
                  "Microsoft.WindowsAzure.ApiManagement.Gateway.Security.Backend.Protocols.Tls11": "false",
                  "Microsoft.WindowsAzure.ApiManagement.Gateway.Security.Ciphers.TripleDes168": "false",
                  "Microsoft.WindowsAzure.ApiManagement.Gateway.Security.Protocols.Ssl30": "false",
                  "Microsoft.WindowsAzure.ApiManagement.Gateway.Security.Protocols.Tls10": "false",
                  "Microsoft.WindowsAzure.ApiManagement.Gateway.Security.Protocols.Tls11": "false"
                }
              },
              "identity": {
                "type": "SystemAssigned"
              }
            },
            {
              "condition": "[not(equals(parameters('baseUrl'), ''))]",
              "type": "Microsoft.ApiManagement/service/customDomains",
              "apiVersion": "2023-05-01-preview",
              "name": "[format('{0}/{1}', parameters('name'), 'default')]",
              "properties": {
                "gatewayDomains": [
                  {
                    "domainName": "[format('{0}.azure-api.net', parameters('baseUrl'))]"
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.ApiManagement/service', parameters('name'))]"
              ]
            }
          ],
          "outputs": {
            "apimServiceName": {
              "type": "string",
              "value": "[parameters('name')]"
            },
            "apimServiceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.ApiManagement/service', parameters('name'))]"
            },
            "gatewayUrl": {
              "type": "string",
              "value": "[format('https://{0}', reference(resourceId('Microsoft.ApiManagement/service', parameters('name')), '2023-05-01-preview').gatewayUrl)]"
            },
            "portalUrl": {
              "type": "string",
              "value": "[format('https://{0}', reference(resourceId('Microsoft.ApiManagement/service', parameters('name')), '2023-05-01-preview').portalUrl)]"
            },
            "managementApiUrl": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ApiManagement/service', parameters('name')), '2023-05-01-preview').managementApiUrl]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "apimBackend",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "apimServiceName": {
            "value": "[variables('apimServiceName')]"
          },
          "functionAppResourceId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'functionApp'), '2025-04-01').outputs.functionAppResourceId.value]"
          },
          "functionAppHostName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'functionApp'), '2025-04-01').outputs.functionAppHostName.value]"
          },
          "backendId": {
            "value": "barberdist-backend"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "15272562186477137800"
            }
          },
          "parameters": {
            "apimServiceName": {
              "type": "string"
            },
            "functionAppResourceId": {
              "type": "string"
            },
            "functionAppHostName": {
              "type": "string"
            },
            "backendId": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.ApiManagement/service/backends",
              "apiVersion": "2023-05-01-preview",
              "name": "[format('{0}/{1}', parameters('apimServiceName'), parameters('backendId'))]",
              "properties": {
                "description": "Backend for Barber Distrito Functions",
                "url": "[format('https://{0}', parameters('functionAppHostName'))]",
                "protocol": "http",
                "resourceId": "[parameters('functionAppResourceId')]",
                "credentials": {
                  "certificate": [],
                  "query": {},
                  "header": {}
                },
                "tls": {
                  "validateCertificateChain": true,
                  "validateCertificateName": true
                }
              }
            }
          ],
          "outputs": {
            "backendId": {
              "type": "string",
              "value": "[parameters('backendId')]"
            },
            "backendUrl": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ApiManagement/service/backends', parameters('apimServiceName'), parameters('backendId')), '2023-05-01-preview').url]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'apiManagement')]",
        "[resourceId('Microsoft.Resources/deployments', 'functionApp')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "apimApis",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "apimServiceName": {
            "value": "[variables('apimServiceName')]"
          },
          "backendId": {
            "value": "barberdist-backend"
          },
          "serviceUrl": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'functionApp'), '2025-04-01').outputs.functionAppUrl.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "2894917120472921879"
            }
          },
          "parameters": {
            "apimServiceName": {
              "type": "string"
            },
            "backendId": {
              "type": "string"
            },
            "serviceUrl": {
              "type": "string"
            }
          },
          "variables": {
            "apiName": "barberdist-api",
            "apiDisplayName": "Distrito Barbearia API",
            "apiDescription": "RESTful API for managing barbers, services, appointments, and sending confirmation emails",
            "apiPath": "barberdist",
            "apiVersion": "v1",
            "apiVersionSetId": "barberdist-versions"
          },
          "resources": [
            {
              "type": "Microsoft.ApiManagement/service/apiVersionSets",
              "apiVersion": "2023-05-01-preview",
              "name": "[format('{0}/{1}', parameters('apimServiceName'), variables('apiVersionSetId'))]",
              "properties": {
                "displayName": "[variables('apiDisplayName')]",
                "versioningScheme": "Segment",
                "description": "[format('Version set for {0}', variables('apiDisplayName'))]"
              }
            },
            {
              "type": "Microsoft.ApiManagement/service/apis",
              "apiVersion": "2023-05-01-preview",
              "name": "[format('{0}/{1}', parameters('apimServiceName'), variables('apiName'))]",
              "properties": {
                "displayName": "[variables('apiDisplayName')]",
                "description": "[variables('apiDescription')]",
                "serviceUrl": "[parameters('serviceUrl')]",
                "path": "[variables('apiPath')]",
                "protocols": [
                  "https"
                ],
                "subscriptionRequired": false,
                "apiVersion": "[variables('apiVersion')]",
                "apiVersionSetId": "[resourceId('Microsoft.ApiManagement/service/apiVersionSets', parameters('apimServiceName'), variables('apiVersionSetId'))]",
                "subscriptionKeyParameterNames": {
                  "header": "Ocp-Apim-Subscription-Key",
                  "query": "subscription-key"
                }
              }
            },
            {
              "type": "Microsoft.ApiManagement/service/apis/backends",
              "apiVersion": "2023-05-01-preview",
              "name": "[format('{0}/{1}/{2}', parameters('apimServiceName'), variables('apiName'), parameters('backendId'))]",
              "properties": {
                "backendId": "[format('/backends/{0}', parameters('backendId'))]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.ApiManagement/service/apis', parameters('apimServiceName'), variables('apiName'))]"
              ]
            },
            {
              "type": "Microsoft.ApiManagement/service/apis/policies",
              "apiVersion": "2023-05-01-preview",
              "name": "[format('{0}/{1}/{2}', parameters('apimServiceName'), variables('apiName'), 'policy')]",
              "properties": {
                "format": "xml",
                "value": "      <policies>\n        <inbound>\n          <base />\n          <set-backend-service backend-id=\"${backendId}\" />\n          <rewrite-uri template=\"/api\" />\n        </inbound>\n        <backend>\n          <base />\n        </backend>\n        <outbound>\n          <base />\n        </outbound>\n        <on-error>\n          <base />\n        </on-error>\n      </policies>\n    "
              },
              "dependsOn": [
                "[resourceId('Microsoft.ApiManagement/service/apis', parameters('apimServiceName'), variables('apiName'))]"
              ]
            }
          ],
          "outputs": {
            "apiId": {
              "type": "string",
              "value": "[variables('apiName')]"
            },
            "apiPath": {
              "type": "string",
              "value": "[variables('apiPath')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'apimBackend')]",
        "[resourceId('Microsoft.Resources/deployments', 'functionApp')]"
      ]
    }
  ],
  "outputs": {
    "functionAppName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'functionApp'), '2025-04-01').outputs.functionAppName.value]"
    },
    "functionAppUrl": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'functionApp'), '2025-04-01').outputs.functionAppUrl.value]"
    },
    "apimServiceName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'apiManagement'), '2025-04-01').outputs.apimServiceName.value]"
    },
    "apimGatewayUrl": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'apiManagement'), '2025-04-01').outputs.gatewayUrl.value]"
    },
    "apimPortalUrl": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'apiManagement'), '2025-04-01').outputs.portalUrl.value]"
    },
    "apimBaseUrl": {
      "type": "string",
      "value": "[variables('apimBaseUrl')]"
    }
  }
}